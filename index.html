<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ - Exodus Competition</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ·: Ø£Ù…ÙŠØ±ÙŠ (ØªØ§Ø±ÙŠØ®ÙŠ) ÙˆØªØ¬ÙˆØ§Ù„ (Ø¹ØµØ±ÙŠ) -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --sea-dark: #0f172a;
            --sea-light: #1e3a8a;
            --sand: #f5f5f4;
            --gold: #fbbf24;
            --fire: #ef4444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--sea-dark);
            color: white;
            overflow-x: hidden;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .biblical-font { font-family: 'Amiri', serif; }
        .number-en { font-family: sans-serif; direction: ltr; display: inline-block; }

        /* --- Ø®Ù„ÙÙŠØ© Ø´Ù‚ Ø§Ù„Ø¨Ø­Ø± --- */
        .red-sea-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;
            background: radial-gradient(circle at center bottom, #2c1a0d 0%, #0f172a 60%);
        }
        .wave-wall {
            position: absolute; top: 0; bottom: 0; width: 35%;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 58, 138, 0.7));
            filter: url(#water); opacity: 0.9; transition: all 2s ease;
        }
        .wave-left { left: 0; transform-origin: left; animation: swell 8s infinite ease-in-out; border-right: 2px solid rgba(255,255,255,0.1); }
        .wave-right { right: 0; transform-origin: right; animation: swell 8s infinite ease-in-out reverse; border-left: 2px solid rgba(255,255,255,0.1); }
        
        @keyframes swell { 0%, 100% { transform: scaleX(1); } 50% { transform: scaleX(1.02); } }

        /* --- Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ --- */
        .competitor-card { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .rank-1 { background: linear-gradient(90deg, rgba(239, 68, 68, 0.25), transparent); border-right: 4px solid var(--fire); }
        .rank-2 { background: linear-gradient(90deg, rgba(251, 191, 36, 0.2), transparent); border-right: 4px solid var(--gold); }
        .rank-3 { background: linear-gradient(90deg, rgba(148, 163, 184, 0.2), transparent); border-right: 4px solid #94a3b8; }
        
        .weekly-winner-glow { animation: holyGlow 3s infinite alternate; }
        @keyframes holyGlow { from { box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.2); } to { box-shadow: inset 0 0 30px rgba(251, 191, 36, 0.5); } }

        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background-color: #ef4444; }
    </style>
</head>
<body>

    <!-- SVG ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ÙŠØ§Ù‡ -->
    <svg style="position: absolute; width: 0; height: 0;"><filter id="water"><feTurbulence type="fractalNoise" baseFrequency="0.01 0.05" numOctaves="3" result="noise" /><feDisplacementMap in="SourceGraphic" in2="noise" scale="20" /></filter></svg>

    <!-- Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© -->
    <div class="red-sea-bg">
        <div class="wave-wall wave-left"></div>
        <div class="wave-wall wave-right"></div>
        <!-- Ø§Ù„Ø·Ø±ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ -->
        <div class="absolute inset-0 flex justify-center items-end opacity-30 pointer-events-none">
            <div class="w-1/4 h-full bg-gradient-to-t from-orange-100/20 to-transparent"></div>
        </div>
    </div>

    <!-- Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ -->
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_884fe92c21.mp3?filename=soft-ambient-116346.mp3" type="audio/mpeg">
    </audio>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="relative z-10 flex flex-col h-full max-w-4xl mx-auto w-full p-4">
        
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <header class="text-center py-4 relative">
            <h1 class="text-3xl md:text-5xl text-amber-400 biblical-font font-bold drop-shadow-lg mb-1">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬</h1>
            <p class="text-blue-200/60 text-sm">ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ - Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</p>
            
            <!-- Ø²Ø± Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ -->
            <button onclick="toggleMusic()" class="absolute top-4 left-4 text-white/50 hover:text-amber-400 transition z-50">
                <i class="fas fa-volume-mute text-2xl" id="musicIcon"></i>
            </button>
        </header>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† -->
        <main class="flex-1 overflow-hidden flex flex-col glass-panel rounded-2xl shadow-2xl mt-2 relative">
            <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
            <div id="loadingOverlay" class="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center">
                <i class="fas fa-spinner fa-spin text-4xl text-amber-500 mb-4"></i>
                <p class="text-amber-100">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>

            <div class="flex justify-between items-center p-4 bg-black/40 text-amber-100/70 text-sm font-bold uppercase">
                <div class="w-16 text-center">#</div>
                <div class="flex-1 pr-4">Ø§Ù„ÙØ±ÙŠÙ‚ / Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</div>
                <div class="w-24 text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
            <div id="leaderboardList" class="flex-1 overflow-y-auto custom-scroll relative">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
            </div>
        </main>

        <!-- Ø§Ù„ÙÙˆØªØ± -->
        <footer class="py-4 text-center text-xs text-white/30 flex justify-between items-center px-4">
            <div class="flex items-center">
                <span id="connectionDot" class="status-dot status-offline"></span>
                <span id="connectionText">ØºÙŠØ± Ù…ØªØµÙ„</span>
            </div>
            <button onclick="openAdminLogin()" class="hover:text-white transition underline">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Admin)</button>
        </footer>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
    <div id="setupModal" class="fixed inset-0 bg-black z-[100] flex items-center justify-center hidden p-4">
        <div class="bg-slate-900 border border-amber-500/50 p-6 rounded-xl max-w-lg w-full text-right shadow-2xl overflow-y-auto max-h-screen">
            <h2 class="text-2xl text-amber-400 font-bold mb-4 text-center biblical-font">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸŒ</h2>
            <p class="text-gray-300 text-sm mb-4 leading-relaxed">
                Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ ÙˆØ§Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ø¨ÙŠÙˆØªÙ‡Ù… (Ø¯ÙˆÙ† Ø£Ù† ØªÙØªØ­ Ø¬Ù‡Ø§Ø²Ùƒ)ØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø®Ø¯Ù…Ø© ØªØ®Ø²ÙŠÙ† Ù…Ø¬Ø§Ù†ÙŠØ© Ù…Ù† Ø¬ÙˆØ¬Ù„ (Firebase).
                <br><br>
                <span class="text-amber-300 font-bold">Ø§ØªØ¨Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·:</span>
            </p>
            
            <ol class="list-decimal list-inside text-sm text-gray-400 space-y-2 mb-6 bg-black/30 p-4 rounded">
                <li>Ø§ÙØªØ­ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-400 underline font-bold">Firebase Console</a> ÙˆØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.</li>
                <li>Ø§Ø¶ØºØ· <strong>Create a project</strong> (Ø³Ù…Ù‘Ù‡ Ø£ÙŠ Ø§Ø³Ù…) ÙˆØ§Ø¶ØºØ· Continue Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ.</li>
                <li>Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ Ø§Ø®ØªØ± <strong>Build</strong> Ø«Ù… <strong>Firestore Database</strong>.</li>
                <li>Ø§Ø¶ØºØ· <strong>Create Database</strong> ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† (Europe Ù…Ø«Ù„Ø§Ù‹).</li>
                <li><span class="text-red-400 font-bold">Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹:</span> Ø§Ø®ØªØ± <strong>Start in test mode</strong> Ø«Ù… Ø§Ø¶ØºØ· Enable.</li>
                <li>Ø§Ø¶ØºØ· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (âš™ï¸) Ø¨Ø¬ÙˆØ§Ø± Project Overview ÙˆØ§Ø®ØªØ± Project Settings.</li>
                <li>Ø§Ù†Ø²Ù„ Ù„Ù„Ø£Ø³ÙÙ„ ÙˆØ§Ø¶ØºØ· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙˆÙŠØ¨ (</>). Ø³Ù…Ù‘Ù‡ Ø£ÙŠ Ø§Ø³Ù… ÙˆØ§Ø¶ØºØ· Register.</li>
                <li>Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ ÙƒÙˆØ¯ØŒ Ø§Ù†Ø³Ø® ÙÙ‚Ø· Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ <span dir="ltr" class="font-mono bg-black px-1 text-green-400">const firebaseConfig = { ... };</span></li>
            </ol>

            <textarea id="configInput" dir="ltr" class="w-full bg-black border border-gray-700 rounded p-3 text-green-400 font-mono text-xs h-32 focus:outline-none focus:border-amber-500" placeholder='Ø£Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§.. Ù…Ø«Ø§Ù„:
{
  apiKey: "AIzaSyB...",
  authDomain: "...",
  projectId: "...",
  ...
}'></textarea>
            
            <button onclick="saveConfig()" class="w-full mt-4 bg-amber-600 hover:bg-amber-500 text-black font-bold py-3 rounded transition shadow-lg shadow-amber-900/50">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„</button>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden">
        <div class="bg-slate-800 p-8 rounded-xl border border-amber-500/30 w-full max-w-sm text-center">
            <h2 class="text-2xl text-amber-400 biblical-font mb-6">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ­ÙƒÙ…</h2>
            <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 bg-slate-900 border border-slate-700 rounded mb-4 text-center text-white focus:outline-none focus:border-amber-500">
            <div class="flex gap-2">
                <button onclick="closeModal('loginModal')" class="flex-1 py-2 bg-slate-700 rounded hover:bg-slate-600">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="checkLogin()" class="flex-1 py-2 bg-amber-600 text-black font-bold rounded hover:bg-amber-500">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin) -->
    <div id="adminModal" class="fixed inset-0 bg-black/95 z-50 flex flex-col hidden overflow-y-auto">
        <div class="p-4 md:p-8 max-w-5xl mx-auto w-full">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-3xl text-amber-400 biblical-font">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
                <div class="flex gap-2">
                    <button onclick="resetConfig()" class="px-3 py-2 bg-slate-800 rounded text-xs text-gray-400 hover:text-white">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
                    <button onclick="closeModal('adminModal')" class="px-4 py-2 bg-red-900/50 hover:bg-red-600 rounded text-red-200">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <!-- Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚ -->
            <div class="bg-slate-800/50 p-6 rounded-xl border border-white/5 mb-8">
                <h3 class="text-xl mb-4 text-blue-200">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="flex flex-col md:flex-row gap-4 items-start">
                    <div class="w-full md:w-auto flex flex-col items-center">
                        <label for="newImgInput" class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center cursor-pointer hover:bg-slate-600 overflow-hidden border-2 border-dashed border-slate-500">
                            <img id="previewImg" src="" class="w-full h-full object-cover hidden">
                            <i id="uploadIcon" class="fas fa-camera text-white/50"></i>
                        </label>
                        <input type="file" id="newImgInput" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                    </div>
                    <input type="text" id="newName" placeholder="Ø§Ù„Ø§Ø³Ù…" class="flex-1 bg-slate-900 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-amber-500 w-full">
                    <input type="number" id="newPoints" placeholder="0" class="w-full md:w-24 bg-slate-900 border border-slate-700 p-3 rounded text-white text-center focus:outline-none focus:border-amber-500 number-en">
                    <button onclick="addCompetitor()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded font-bold w-full md:w-auto">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
            <div class="bg-slate-800/50 p-6 rounded-xl border border-white/5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl text-blue-200">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                    <button onclick="deleteAllData()" class="text-xs text-red-400 hover:text-red-300 underline">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
                </div>
                <div id="adminList" class="space-y-2"></div>
            </div>
            
            <button onclick="closeModal('adminModal')" class="mt-8 mx-auto block text-slate-400 hover:text-white">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Global Variables ---
        window.db = null;
        window.auth = null;
        window.competitors = [];
        const DOC_ID = 'exodus_leaderboard_data'; // ID Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ø³ØªÙ†Ø¯
        
        // --- 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ ---
        window.addEventListener('DOMContentLoaded', async () => {
            const savedConfig = localStorage.getItem('exodus_firebase_config');
            
            if (!savedConfig) {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -> Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('setupModal').classList.remove('hidden');
            } else {
                // ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§ØªØµØ§Ù„
                try {
                    const firebaseConfig = JSON.parse(savedConfig);
                    initFirebase(firebaseConfig);
                } catch (e) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.");
                    localStorage.removeItem('exodus_firebase_config');
                    location.reload();
                }
            }
        });

        // --- 2. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ---
        window.saveConfig = function() {
            const input = document.getElementById('configInput').value;
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒØ§Ø¦Ù† ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„ Ù†Ø³Ø® Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù†ØµÙˆØµ Ø²Ø§Ø¦Ø¯Ø©)
            try {
                // --- ØªØ­Ø³ÙŠÙ† Ø°ÙƒÙŠ (Updated Logic) ---
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ§Ø¦Ù† {}
                const firstBrace = input.indexOf('{');
                const lastBrace = input.lastIndexOf('}');
                
                let cleanJson;
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙÙ‚Ø·
                    cleanJson = input.substring(firstBrace, lastBrace + 1);
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø£Ù‚ÙˆØ§Ø³ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ù‡ Ù†Ø¸ÙŠÙØ§Ù‹)
                    cleanJson = input;
                }

                // ØªÙ†Ø¸ÙŠÙ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø²Ø§Ù„Ø© const, variable names, trailing comma
                cleanJson = cleanJson.replace(/const\s+\w+\s*=\s*/, '')
                                     .replace(/;/g, '');

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± Ø§Ù„Ù…Ù‚ØªØ¨Ø³Ø© Ø¥Ù„Ù‰ Ù…Ù‚ØªØ¨Ø³Ø© (JS Object -> JSON)
                cleanJson = cleanJson.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2": ');
                cleanJson = cleanJson.replace(/'/g, '"'); // ØªÙˆØ­ÙŠØ¯ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ JSON
                JSON.parse(cleanJson); // Just to test parsing
                
                localStorage.setItem('exodus_firebase_config', cleanJson);
                document.getElementById('setupModal').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('hidden');
                location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
            } catch (e) {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ù…Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ { ... } ÙÙ‚Ø·.");
                console.error(e);
            }
        }

        window.resetConfig = function() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ØŸ")) {
                localStorage.removeItem('exodus_firebase_config');
                location.reload();
            }
        }

        // --- 3. ØªÙ‡ÙŠØ¦Ø© Firebase ---
        async function initFirebase(config) {
            try {
                const app = initializeApp(config);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ÙƒØªØ§Ø¨Ø©)
                await signInAnonymously(window.auth);
                
                updateConnectionStatus(true);
                document.getElementById('loadingOverlay').classList.add('hidden');

                // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª (Realtime Listener)
                startListening();

            } catch (error) {
                console.error("Firebase Error:", error);
                alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ØŒ ÙˆÙ…Ù† ØªÙØ¹ÙŠÙ„ 'Test Mode' ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('setupModal').classList.remove('hidden');
            }
        }

        // --- 4. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function startListening() {
            const docRef = doc(window.db, "competitions", DOC_ID);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.competitors = docSnap.data().teams || [];
                    renderLeaderboard();
                    if(!document.getElementById('adminModal').classList.contains('hidden')) {
                        renderAdminList();
                    }
                } else {
                    // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                    const sampleData = [
                        { id: 1, name: "ÙØ±ÙŠÙ‚ Ù…ÙˆØ³Ù‰", points: 150, image: null },
                        { id: 2, name: "ÙØ±ÙŠÙ‚ Ù‡Ø§Ø±ÙˆÙ†", points: 120, image: null }
                    ];
                    setDoc(docRef, { teams: sampleData });
                }
            }, (error) => {
                console.error("Listener Error:", error);
                updateConnectionStatus(false);
            });
        }

        // --- 5. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Admin Actions) ---
        window.saveDataToCloud = async function() {
            if (!window.db) return;
            // ØªØ±ØªÙŠØ¨
            window.competitors.sort((a, b) => b.points - a.points);
            try {
                await setDoc(doc(window.db, "competitions", DOC_ID), { 
                    teams: window.competitors 
                });
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + e.message);
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…ØªØ§Ø­Ø© ÙÙŠ window) ---
        window.addCompetitor = function() {
            const name = document.getElementById('newName').value.trim();
            if (!name) return;
            const newTeam = { 
                id: Date.now(), 
                name: name, 
                points: parseInt(document.getElementById('newPoints').value)||0, 
                image: window.tempImageBase64 
            };
            window.competitors.push(newTeam);
            saveDataToCloud();
            // Reset UI
            document.getElementById('newName').value = '';
            document.getElementById('newPoints').value = '';
            window.tempImageBase64 = null;
            document.getElementById('previewImg').classList.add('hidden');
            document.getElementById('uploadIcon').classList.remove('hidden');
        }

        window.changePoints = function(id, delta) {
            const c = window.competitors.find(x => x.id === id);
            if(c) { c.points += delta; saveDataToCloud(); }
        }

        window.manualEditPoints = function(id, val) {
            const c = window.competitors.find(x => x.id === id);
            if(c) { c.points = parseInt(val)||0; saveDataToCloud(); }
        }

        window.deleteCompetitor = function(id) {
            if(confirm('Ø­Ø°ÙØŸ')) {
                window.competitors = window.competitors.filter(c => c.id !== id);
                saveDataToCloud();
            }
        }

        window.deleteAllData = function() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ')) {
                window.competitors = [];
                saveDataToCloud();
            }
        }
    </script>

    <!-- Vanilla JS Logic for UI -->
    <script>
        // Icons
        const icons = {
            fire: `<svg class="w-8 h-8 text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c4.97 0 9-4.03 9-9 0-4.97-9-13-9-13S3 8.03 3 13c0 4.97 4.03 9 9 9zm0-2c-3.87 0-7-3.13-7-7 0-2.26 3.14-6.42 5.71-9.69C11.54 4.3 12 3.71 12 3.71s.46.59 1.29 1.6C15.86 8.58 19 12.74 19 13c0 3.87-3.13 7-7 7z"/></svg>`,
            tablets: `<svg class="w-8 h-8 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M6 2h12a2 2 0 012 2v18H4V4a2 2 0 012-2zm2 4v2h2V6H8zm4 0v2h2V6h-2zm-4 4v2h2v-2H8zm4 0v2h2v-2h-2zm-4 4v2h2v-2H8zm4 0v2h2v-2h-2z"/></svg>`,
            staff: `<svg class="w-8 h-8 text-amber-600 transform rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M5 22h2l1.5-5 .5-1.5L7 3h2l2 12.5.5 1.5L13 22h2l-2.5-7-2-13H8L6 15z"/></svg>`
        };

        // Render Functions
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            
            if (window.competitors.length === 0) {
                list.innerHTML = '<div class="text-center text-white/50 py-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø¨Ø¹Ø¯</div>';
                return;
            }

            window.competitors.forEach((c, index) => {
                const rank = index + 1;
                let rankClass = '', rankIcon = `<span class="text-xl font-bold number-en text-slate-500">#${rank}</span>`, glowClass = '';
                
                if (rank === 1) { rankClass = 'rank-1'; rankIcon = icons.fire; glowClass = 'weekly-winner-glow'; }
                else if (rank === 2) { rankClass = 'rank-2'; rankIcon = icons.tablets; }
                else if (rank === 3) { rankClass = 'rank-3'; rankIcon = icons.staff; }

                const imgDisplay = c.image ? `<img src="${c.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-slate-700 flex items-center justify-center text-slate-500 font-bold text-lg">${c.name.charAt(0)}</div>`;

                const html = `
                    <div class="competitor-card flex items-center p-4 ${rankClass} ${glowClass}">
                        <div class="w-16 flex justify-center items-center">${rankIcon}</div>
                        <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-white/20 ml-4 shadow-lg shrink-0">${imgDisplay}</div>
                        <div class="flex-1 mr-4">
                            <h3 class="text-lg md:text-xl font-bold text-white truncate">${c.name}</h3>
                            ${rank === 1 ? '<span class="text-[10px] text-amber-400 font-bold animate-pulse">Ù…ØªØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span>' : ''}
                        </div>
                        <div class="w-24 text-center">
                            <span class="text-2xl font-bold text-amber-400 number-en">${c.points}</span>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderAdminList() {
            const list = document.getElementById('adminList');
            list.innerHTML = '';
            window.competitors.forEach((c) => {
                list.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded border border-slate-700">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="w-8 h-8 rounded-full bg-slate-700 overflow-hidden shrink-0">${c.image ? `<img src="${c.image}" class="w-full h-full object-cover">` : ''}</div>
                            <span class="truncate text-sm">${c.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changePoints(${c.id}, -5)" class="w-8 h-8 bg-slate-700 rounded hover:bg-red-900 text-red-200 number-en font-bold">-5</button>
                            <input onchange="manualEditPoints(${c.id}, this.value)" type="number" value="${c.points}" class="w-14 bg-black border border-slate-600 rounded p-1 text-center text-amber-400 number-en text-sm">
                            <button onclick="changePoints(${c.id}, 5)" class="w-8 h-8 bg-slate-700 rounded hover:bg-green-900 text-green-200 number-en font-bold">+5</button>
                            <button onclick="deleteCompetitor(${c.id})" class="w-8 h-8 ml-1 text-slate-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `);
            });
        }

        // --- Helpers ---
        function updateConnectionStatus(isOnline) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            if(isOnline) {
                dot.className = 'status-dot status-online';
                text.textContent = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                text.className = 'text-green-400';
            } else {
                dot.className = 'status-dot status-offline';
                text.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                text.className = 'text-red-400';
            }
        }

        function openAdminLogin() { document.getElementById('loginModal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function checkLogin() {
            if (document.getElementById('adminPass').value === '1123') {
                closeModal('loginModal'); 
                document.getElementById('adminPass').value = '';
                document.getElementById('adminModal').classList.remove('hidden'); 
                renderAdminList();
            } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        }

        // Image Handling
        window.tempImageBase64 = null;
        window.handleImagePreview = function(input) {
            if (input.files && input.files[0]) {
                if(input.files[0].size > 150000) return alert("Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹! ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 150KB) Ù„Ø¶Ù…Ø§Ù† Ø³Ø±Ø¹Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±.");
                const reader = new FileReader();
                reader.onload = (e) => {
                    window.tempImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = window.tempImageBase64;
                    document.getElementById('previewImg').classList.remove('hidden');
                    document.getElementById('uploadIcon').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Music
        function toggleMusic() {
            const audio = document.getElementById('bgMusic');
            const icon = document.getElementById('musicIcon');
            if(audio.paused) { 
                audio.play(); 
                icon.className = 'fas fa-volume-up text-amber-400'; 
            } else { 
                audio.pause(); 
                icon.className = 'fas fa-volume-mute text-white/50'; 
            }
        }
    </script>
</body>
</html>
