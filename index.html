<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ - Exodus Competition</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,700&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --sea-dark: #0f172a; --sea-light: #1e3a8a; --sand: #f5f5f4; --gold: #fbbf24; --fire: #ef4444; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--sea-dark); color: white; overflow-x: hidden; height: 100vh; margin: 0; display: flex; flex-direction: column; }
        .biblical-font { font-family: 'Amiri', serif; }
        .number-en { font-family: sans-serif; direction: ltr; display: inline-block; }

        /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø­Ø± */
        .red-sea-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at center bottom, #2c1a0d 0%, #0f172a 60%); }
        .wave-wall { position: absolute; top: 0; bottom: 0; width: 35%; background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 58, 138, 0.7)); filter: url(#water); opacity: 0.9; transition: all 2s ease; }
        .wave-left { left: 0; transform-origin: left; animation: swell 8s infinite ease-in-out; border-right: 2px solid rgba(255,255,255,0.1); }
        .wave-right { right: 0; transform-origin: right; animation: swell 8s infinite ease-in-out reverse; border-left: 2px solid rgba(255,255,255,0.1); }
        @keyframes swell { 0%, 100% { transform: scaleX(1); } 50% { transform: scaleX(1.02); } }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .competitor-card { transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
        .rank-1 { background: linear-gradient(90deg, rgba(239, 68, 68, 0.25), transparent); border-right: 4px solid var(--fire); }
        .rank-2 { background: linear-gradient(90deg, rgba(251, 191, 36, 0.2), transparent); border-right: 4px solid var(--gold); }
        .rank-3 { background: linear-gradient(90deg, rgba(148, 163, 184, 0.2), transparent); border-right: 4px solid #94a3b8; }
        .weekly-winner-glow { animation: holyGlow 3s infinite alternate; }
        @keyframes holyGlow { from { box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.2); } to { box-shadow: inset 0 0 30px rgba(251, 191, 36, 0.5); } }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-warning { background-color: #fbbf24; box-shadow: 0 0 8px #fbbf24; }

        /* Avatar & Icons (Soccer Legends Style) */
        .avatar-svg { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transition: transform 0.3s; }
        .big-head-wrapper { transform-origin: bottom center; transition: transform 0.2s; cursor: pointer; }
        .big-head-wrapper:hover { transform: scale(1.1) rotate(2deg); }
        
        /* Creator Controls */
        .creator-tab { 
            padding: 8px;
            font-size: 0.85rem; 
            border-top-left-radius: 0.5rem; 
            border-top-right-radius: 0.5rem;
            background-color: #1e293b; 
            color: #9ca3af; 
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }
        .creator-tab:hover { background-color: #334155; }
        .creator-tab.active { 
            background-color: #334155; 
            color: #fbbf24; 
            border-bottom-color: #fbbf24;
        }

        .option-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 10px; 
            max-height: 250px; 
            overflow-y: auto; 
            padding: 10px; 
        }
        
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; margin: 0 auto; }
        .color-dot.selected { border-color: var(--gold); transform: scale(1.2); box-shadow: 0 0 10px var(--gold); }
        
        .item-btn { 
            background-color: #1e293b; 
            border-radius: 0.5rem; 
            border: 2px solid #475569; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .item-btn:hover { border-color: #fbbf24; }
        .item-btn.selected { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        /* Miracle Animations (Local Only) */
        #miracleOverlay { pointer-events: none; }
        .miracle-btn { cursor: pointer; transition: all 0.2s; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); opacity: 0.9; }
        .miracle-btn:hover { transform: scale(1.2); opacity: 1; filter: drop-shadow(0 0 8px var(--gold)); }
        .miracle-btn:active { transform: scale(0.9); }

        /* Passing Animation (Friendly) */
        @keyframes passJump {
            0% { transform: translateY(0); }
            30% { transform: translateY(-15px) scale(1.05); }
            50% { transform: translateY(0) scale(1); box-shadow: 0 0 25px var(--gold); background: rgba(251, 191, 36, 0.1); }
            70% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        .pass-anim { animation: passJump 0.8s ease-in-out; z-index: 20; border: 1px solid var(--gold); }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        
        /* Auth Form */
        .auth-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #475569; padding: 10px; border-radius: 8px; color: white; text-align: center; margin-bottom: 10px; }
        .auth-input:focus { outline: none; border-color: #fbbf24; }
        
        /* Hidden Auth UI */
        .hidden-important { display: none !important; }
    </style>
</head>
<body>
    <svg style="position: absolute; width: 0; height: 0;"><filter id="water"><feTurbulence type="fractalNoise" baseFrequency="0.01 0.05" numOctaves="3" result="noise" /><feDisplacementMap in="SourceGraphic" in2="noise" scale="20" /></filter></svg>
    <div class="red-sea-bg"><div class="wave-wall wave-left"></div><div class="wave-wall wave-right"></div><div class="absolute inset-0 flex justify-center items-end opacity-30 pointer-events-none"><div class="w-1/4 h-full bg-gradient-to-t from-orange-100/20 to-transparent"></div></div></div>
    <audio id="bgMusic" loop><source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_884fe92c21.mp3?filename=soft-ambient-116346.mp3" type="audio/mpeg"></audio>

    <!-- Miracle Overlay Container -->
    <div id="miracleOverlay" class="fixed inset-0 z-[100] pointer-events-none flex items-center justify-center hidden overflow-hidden"></div>

    <div class="relative z-10 flex flex-col h-full max-w-5xl mx-auto w-full p-4">
        <header class="text-center py-2 relative">
            <h1 class="text-4xl md:text-6xl text-amber-400 biblical-font font-bold drop-shadow-lg mb-4">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬</h1>
            
            <!-- Bible Verse Block (Smaller Size) -->
            <div class="bg-black/40 p-3 rounded-xl border-y-2 border-amber-500/30 max-w-2xl mx-auto mb-4 backdrop-blur-sm shadow-xl">
                <p class="text-amber-100/95 text-xs leading-loose biblical-font text-center" style="direction: rtl;">
                    Â«Ù„ÙØ°ÙÙ„ÙÙƒÙ Ù‚ÙÙ„Ù’ Ù„ÙØ¨ÙÙ†ÙÙŠ Ø¥ÙØ³Ù’Ø±ÙØ§Ø¦ÙÙŠÙ„Ù: Ø£ÙÙ†ÙØ§ Ø§Ù„Ø±ÙÙ‘Ø¨ÙÙ‘. ÙˆÙØ£ÙÙ†ÙØ§ Ø£ÙØ®Ù’Ø±ÙØ¬ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ ØªÙØ­Ù’ØªÙ Ø£ÙØ«Ù’Ù‚ÙØ§Ù„Ù Ø§Ù„Ù’Ù…ÙØµÙ’Ø±ÙÙŠÙÙ‘ÙŠÙ†Ù ÙˆÙØ£ÙÙ†Ù’Ù‚ÙØ°ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ Ø¹ÙØ¨ÙÙˆØ¯ÙÙŠÙÙ‘ØªÙÙ‡ÙÙ…Ù’...
                    <span class="text-amber-500 font-bold number-en mx-1">7</span> ÙˆÙØ£ÙØªÙÙ‘Ø®ÙØ°ÙÙƒÙÙ…Ù’ Ù„ÙÙŠ Ø´ÙØ¹Ù’Ø¨Ù‹Ø§... ÙˆÙØ£ÙØ¹Ù’Ø·ÙÙŠÙÙƒÙÙ…Ù’ Ø¥ÙÙŠÙÙ‘Ø§Ù‡ÙØ§ Ù…ÙÙŠØ±ÙØ§Ø«Ù‹Ø§. Ø£ÙÙ†ÙØ§ Ø§Ù„Ø±ÙÙ‘Ø¨ÙÙ‘Â».
                </p>
                <p class="text-amber-400/60 text-[10px] mt-1 text-center font-sans number-en">(Ø®Ø±ÙˆØ¬ 6: 6-8)</p>
            </div>

            <!-- Controls -->
            <button onclick="toggleMusic()" class="absolute top-4 left-4 text-white/50 hover:text-amber-400 transition z-50 p-2"><i class="fas fa-volume-mute text-2xl" id="musicIcon"></i></button>
            <button onclick="openVerseModal()" class="absolute top-4 right-4 text-amber-500 hover:text-amber-300 transition z-50 hover:scale-110 p-2"><i class="fas fa-bookmark text-4xl drop-shadow-[0_0_15px_rgba(251,191,36,0.6)]"></i></button>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col glass-panel rounded-2xl shadow-2xl mt-2 relative">
            <div id="loadingOverlay" class="absolute inset-0 bg-slate-900/95 z-20 flex flex-col items-center justify-center p-6 text-center">
                <i id="loadingIcon" class="fas fa-spinner fa-spin text-4xl text-amber-500 mb-4"></i>
                <div id="loadingMsg" class="text-amber-100 max-w-md">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
            
            <div class="flex justify-between items-center p-3 bg-black/40 text-amber-100/70 text-sm font-bold uppercase border-b border-white/5">
                <div class="w-10 text-center">#</div>
                <div class="w-16 text-center">Ø§Ù„Ø¨Ø·Ù„</div>
                <div class="flex-1 pr-4 text-right">Ø§Ù„Ø§Ø³Ù…</div>
                <div class="w-20 text-center">Ø§Ù„Ù…Ø¹Ø¬Ø²Ø©</div>
                <div class="w-16 text-center">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
            
            <div id="leaderboardList" class="flex-1 overflow-y-auto custom-scroll relative p-2 space-y-2">
                <!-- Rows injected here -->
            </div>
        </main>

        <footer class="py-4 text-center text-xs text-white/30 flex justify-between items-center px-4">
            <div class="flex items-center"><span id="connectionDot" class="status-dot status-warning"></span><span id="connectionText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</span></div>
            <button onclick="openAdminLogin()" class="hover:text-white transition underline">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Admin)</button>
        </footer>
    </div>

    <!-- AUTH / SIGN UP MODAL -->
    <div id="signupModal" class="fixed inset-0 bg-black/95 z-[100] flex flex-col items-center justify-center hidden p-4 overflow-y-auto">
        <div id="authBox" class="w-full max-w-md bg-slate-900 border border-amber-500/30 rounded-2xl p-8 shadow-2xl flex flex-col items-center">
            <h2 class="text-3xl text-amber-400 biblical-font mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-gray-400 text-xs mb-6 text-center">
                Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ.<br>
                (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
            </p>
            <input type="email" id="authEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="auth-input">
            <input type="password" id="authPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" class="auth-input">
            <button onclick="handleAuth()" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-bold py-3 rounded-lg mt-2 transition transform hover:scale-[1.02]">Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            <p id="authError" class="text-red-400 text-xs mt-3 hidden text-center bg-red-900/20 p-2 rounded w-full"></p>
        </div>

        <div id="creatorBox" class="w-full max-w-5xl bg-slate-900 border border-amber-500/30 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] hidden">
            <!-- 1. Preview -->
            <div class="md:w-1/3 bg-slate-800/50 p-6 flex flex-col items-center justify-center border-b md:border-b-0 md:border-l border-white/10">
                <h2 class="text-2xl text-amber-400 biblical-font mb-2">Ø§ØµÙ†Ø¹ Ø¨Ø·Ù„Ùƒ</h2>
                <div class="relative w-64 h-64 mb-4 bg-gradient-to-b from-blue-900/20 to-transparent rounded-full border border-white/5 flex items-center justify-center transform hover:scale-105 transition duration-500">
                    <div id="signupAvatarPreview" class="w-56 h-56"></div>
                </div>
                <div class="w-full space-y-3">
                    <input type="text" id="signupName" placeholder="Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©" class="auth-input text-lg font-bold">
                    <div class="bg-black/30 p-3 rounded-xl border border-slate-700 flex items-center justify-between px-4">
                        <span class="text-gray-400 text-xs">Ø§Ù„Ù…Ø¹Ø¬Ø²Ø©:</span>
                        <div class="flex items-center gap-2 text-amber-400 font-bold">
                            <span id="signupMiracleName" class="text-sm">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
                            <span id="signupMiracleIcon" class="text-2xl">âœ¨</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 2. Customization -->
            <div class="md:w-2/3 p-6 flex flex-col bg-slate-900">
                <div class="flex gap-1 mb-4 border-b border-white/10 pb-1 overflow-x-auto">
                    <button onclick="setTab('skin')" class="creator-tab active" id="tab-skin">Ø§Ù„Ø¨Ø´Ø±Ø©</button>
                    <button onclick="setTab('hair')" class="creator-tab" id="tab-hair">Ø§Ù„Ø´Ø¹Ø±</button>
                    <button onclick="setTab('eyes')" class="creator-tab" id="tab-eyes">Ø§Ù„Ø¹ÙŠÙˆÙ†</button>
                    <button onclick="setTab('clothes')" class="creator-tab" id="tab-clothes">Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</button>
                    <button onclick="setTab('miracle')" class="creator-tab text-amber-300" id="tab-miracle">Ø§Ù„Ù…Ø¹Ø¬Ø²Ø©</button>
                </div>
                <div id="optionsContainer" class="flex-1 overflow-y-auto custom-scroll min-h-[300px] mb-6 bg-black/20 rounded-xl border border-white/5 p-4"></div>
                <button onclick="saveNewCharacter()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg transform hover:scale-[1.01] transition">
                    Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ <i class="fas fa-check mr-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Verse Modal -->
    <div id="verseModal" class="fixed inset-0 bg-black/80 z-[80] flex items-start justify-end hidden">
        <div class="h-full w-full md:w-1/3 bg-slate-900 border-l border-amber-500/50 p-6 shadow-2xl transform transition-transform duration-300 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl text-amber-400 biblical-font"><i class="fas fa-scroll ml-2"></i>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
                <button onclick="closeModal('verseModal')" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="verseDisplay" class="bg-black/30 p-6 rounded-lg border border-white/5 min-h-[200px]">
                <p id="verseText" class="text-white text-lg leading-loose font-serif text-justify whitespace-pre-wrap">Ø§Ù†ØªØ¸Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ø¯...</p>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center hidden">
        <div class="bg-slate-800 p-8 rounded-xl border border-amber-500/30 w-full max-w-sm text-center">
            <h2 class="text-2xl text-amber-400 biblical-font mb-6">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
            <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password" class="w-full p-3 bg-slate-900 border border-slate-700 rounded mb-4 text-center text-white focus:outline-none focus:border-amber-500">
            <div class="flex gap-2"><button onclick="closeModal('loginModal')" class="flex-1 py-2 bg-slate-700 rounded">Ø¥Ù„ØºØ§Ø¡</button><button onclick="checkLogin()" class="flex-1 py-2 bg-amber-600 text-black font-bold rounded">Ø¯Ø®ÙˆÙ„</button></div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black/95 z-[95] flex flex-col hidden overflow-y-auto">
        <div class="p-4 md:p-8 max-w-6xl mx-auto w-full">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-3xl text-amber-400 biblical-font">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <button onclick="closeModal('adminModal')" class="px-4 py-2 bg-red-900/50 hover:bg-red-600 rounded text-red-200">Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-slate-800/80 p-6 rounded-xl border border-amber-500/30">
                    <h3 class="text-xl text-amber-300 mb-4 font-bold border-b border-white/10 pb-2"><i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
                    <textarea id="adminVerseInput" class="w-full h-40 bg-slate-900 border border-slate-600 rounded p-4 text-white focus:border-amber-500 focus:outline-none text-right mb-4 leading-relaxed text-lg"></textarea>
                    <button onclick="saveVerseFromAdmin()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold shadow-lg">Ø­ÙØ¸ ÙˆÙ†Ø´Ø±</button>
                </div>
                <div class="bg-slate-800/80 p-6 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                        <h3 class="text-xl text-blue-200 font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                        <button onclick="deleteAllData()" class="text-xs text-red-400 hover:text-red-300 underline">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
                    </div>
                    <div id="adminList" class="space-y-2 max-h-[60vh] overflow-y-auto custom-scroll pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const manualConfig = {
          apiKey: "AIzaSyDaiNplUIh8mFFOUmFTx-dnEC9HxeL2wF8",
          authDomain: "kkww-54462.firebaseapp.com",
          projectId: "kkww-54462",
          storageBucket: "kkww-54462.firebasestorage.app",
          messagingSenderId: "988360114007",
          appId: "1:988360114007:web:5b64245ad1440dbb848812"
        };

        window.db = null;
        window.auth = null;
        window.currentUser = null;
        window.competitors = [];
        window.currentVerse = "Ø§Ù†ØªØ¸Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯...";
        window.isAdmin = false;
        
        window.avatarState = { skinColor: '#e8beac', hairColor: '#1a1a1a', hairStyle: 0, eyeStyle: 0, mouthStyle: 0, clothesStyle: 0, clothesColor: '#3b82f6', extra: 0 };
        window.selectedMiracle = 'bush'; 

        const ASSETS = {
            skinColors: ['#fca', '#e8beac', '#d08d72', '#a67b5b', '#8d5524', '#593a23'],
            hairColors: ['#1a1a1a', '#4a3000', '#8b4513', '#d6c000', '#a00', '#808080', '#f0f0f0'],
            clothesColors: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ffffff', '#333333'],
            miracles: [
                { id: 'bush', icon: 'ğŸŒ³', transform: 'ğŸ”¥ğŸŒ³', name: 'Ø§Ù„Ø¹Ù„ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´ØªØ¹Ù„Ø©' },
                { id: 'snake', icon: 'ğŸªµ', transform: 'ğŸ', name: 'Ø§Ù„Ø¹ØµØ§ Ø«Ø¹Ø¨Ø§Ù†' },
                { id: 'blood', icon: 'ğŸ’§', transform: 'ğŸ©¸', name: 'Ø§Ù„Ù…Ø§Ø¡ Ø¯Ù…' },
                { id: 'sea', icon: 'ğŸŒŠ', transform: 'ğŸŒŠğŸ›¤ï¸', name: 'Ø´Ù‚ Ø§Ù„Ø¨Ø­Ø±' },
                { id: 'frog', icon: 'â›²', transform: 'ğŸ¸', name: 'Ø§Ù„Ø¶ÙØ§Ø¯Ø¹' },
                { id: 'light', icon: 'â˜ï¸', transform: 'âœ¨', name: 'Ù†ÙˆØ± Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø¡' },
                { id: 'manna', icon: 'ğŸ§º', transform: 'ğŸ', name: 'Ø§Ù„Ù…Ù† ÙˆØ§Ù„Ø³Ù„ÙˆÙ‰' },
            ]
        };

        // SOCCER LEGENDS STYLE PATHS (Big Squircle Head)
        const PATHS = {
            hair: [
                // 0: Modern Spiky - Shifted UP to not cover eyes
                `M20,20 L20,5 L30,20 L40,0 L50,20 L60,0 L70,20 L80,5 L80,20 L80,35 Q50,25 20,35 Z`,
                // 1: Slick Back
                `M20,25 Q20,-5 50,-10 Q80,-5 80,25 L80,35 Q50,25 20,35 Z`,
                // 2: Side Part
                `M15,25 Q40,-15 85,20 L85,40 L80,40 Q50,30 20,40 Z`,
                // 3: Afro / Curly
                `M15,25 Q10,-5 30,-5 Q50,-15 70,-5 Q90,-5 85,25 L85,40 Q50,30 15,40 Z`,
                // 4: Long Flowing
                `M20,15 Q50,-10 80,15 L85,65 L75,65 L75,35 Q50,25 25,35 L25,65 L15,65 Z`
            ],
            eyes: [
                // 0: Big Anime/Cartoon - Moved Down
                `<g><circle cx="38" cy="50" r="5" fill="white" stroke="#222"/><circle cx="38" cy="50" r="2" fill="black"/><circle cx="62" cy="50" r="5" fill="white" stroke="#222"/><circle cx="62" cy="50" r="2" fill="black"/><path d="M32,43 Q38,40 44,43" stroke="#222" stroke-width="2" fill="none"/><path d="M56,43 Q62,40 68,43" stroke="#222" stroke-width="2" fill="none"/></g>`,
                // 1: Determined
                `<g><path d="M32,47 L44,50" stroke="#222" stroke-width="2"/><path d="M68,47 L56,50" stroke="#222" stroke-width="2"/><circle cx="38" cy="53" r="3" fill="black"/><circle cx="62" cy="53" r="3" fill="black"/></g>`,
                // 2: Happy
                `<g><path d="M34,50 Q38,45 42,50" stroke="#222" stroke-width="2" fill="none"/><path d="M58,50 Q62,45 66,50" stroke="#222" stroke-width="2" fill="none"/></g>`
            ],
            mouths: [
                `<path d="M42,65 Q50,70 58,65" fill="none" stroke="#222" stroke-width="2" stroke-linecap="round"/>`, 
                `<rect x="42" y="65" width="16" height="4" rx="2" fill="white" stroke="#222"/>`,
                `<circle cx="50" cy="67" r="4" fill="#222"/>`
            ],
            clothes: [
                "M25,85 Q50,125 75,85 L75,115 Q50,125 25,115 Z", // Jersey
                "M20,85 L80,85 L85,115 L15,115 Z", // Robe
            ]
        };

        const DOC_ID = 'exodus_leaderboard_data';

        // --- Avatar Generator ---
        window.getAvatarSVG = function(s) {
            if(!s) s = { skinColor: '#e8beac', hairColor: '#1a1a1a', hairStyle: 0, eyeStyle: 0, mouthStyle: 0, clothesStyle: 0, clothesColor: '#3b82f6', extra: 0 };
            return `
            <svg viewBox="0 0 100 120" class="w-full h-full drop-shadow-xl avatar-svg">
                <!-- Body -->
                <path d="${PATHS.clothes[s.clothesStyle] || PATHS.clothes[0]}" fill="${s.clothesColor}" />
                <path d="M25,85 L15,100 M75,85 L85,100" stroke="${s.clothesColor}" stroke-width="4" stroke-linecap="round"/>
                
                <!-- Head Group -->
                <g transform="translate(0, 5)">
                    <!-- Face Shape (Squircle for Soccer Legend Look) -->
                    <rect x="25" y="20" width="50" height="60" rx="18" fill="${s.skinColor}" />
                    <!-- Nose -->
                    <path d="M50,53 L48,60 L52,60 Z" fill="#dbbba5" opacity="0.5"/>
                    <!-- Features -->
                    ${PATHS.eyes[s.eyeStyle] || PATHS.eyes[0]}
                    ${PATHS.mouths[s.mouthStyle] || PATHS.mouths[0]}
                    <!-- Hair (On Top) -->
                    <path d="${PATHS.hair[s.hairStyle] || PATHS.hair[0]}" fill="${s.hairColor}" />
                </g>
            </svg>
            `;
        }

        window.updateSignupPreview = function() {
            document.getElementById('signupAvatarPreview').innerHTML = window.getAvatarSVG(window.avatarState);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(manualConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                // Realtime Data Listener
                const docRef = doc(window.db, "competitions", DOC_ID);
                let prevData = [];

                onSnapshot(docRef, (docSnap) => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const newCompetitors = data.teams || [];
                        window.currentVerse = data.verse || "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ…...";
                        
                        document.getElementById('verseText').textContent = window.currentVerse;
                        const adminInput = document.getElementById('adminVerseInput');
                        if(adminInput) adminInput.value = window.currentVerse;

                        checkPassAnimation(prevData, newCompetitors);
                        window.competitors = newCompetitors;
                        prevData = JSON.parse(JSON.stringify(newCompetitors));

                        renderLeaderboard();
                        if(window.isAdmin) renderAdminList();
                        
                        // Smart Auth Check: If logged in, check if user has a character
                        if (window.currentUser) {
                            const myChar = window.competitors.find(c => c.id === window.currentUser.uid);
                            if (myChar) {
                                // Has character -> Hide all modals
                                document.getElementById('signupModal').classList.add('hidden');
                            } else {
                                // Logged in but NO character -> Show Creator
                                document.getElementById('signupModal').classList.remove('hidden');
                                document.getElementById('authBox').classList.add('hidden');
                                document.getElementById('creatorBox').classList.remove('hidden');
                                if (!document.querySelector('.creator-tab.active')) {
                                    window.setTab('skin');
                                    renderOptions('skin');
                                    window.updateSignupPreview();
                                }
                            }
                        }
                    } else {
                        setDoc(docRef, { teams: [], verse: "Ù…Ø±Ø­Ø¨Ø§Ù‹" });
                    }
                });

                // Auth Listener
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUser = user;
                        document.getElementById('connectionDot').className = 'status-dot status-online';
                        document.getElementById('connectionText').textContent = user.email;
                    } else {
                        // Not logged in -> Show Login
                        document.getElementById('signupModal').classList.remove('hidden');
                        document.getElementById('authBox').classList.remove('hidden');
                        document.getElementById('creatorBox').classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            }
        });

        // --- Auth Logic (Smart Button) ---
        window.handleAuth = async function() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const errBox = document.getElementById('authError');
            
            if(!email || !pass) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
                return;
            }
            
            const btn = document.querySelector('#authBox button');
            const originalText = btn.innerText;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            btn.disabled = true;
            errBox.classList.add('hidden');

            try {
                // 1. Try Login
                await signInWithEmailAndPassword(window.auth, email, pass);
                // Success -> onAuthStateChanged handles the rest
            } catch (e) {
                // 2. If User Not Found -> Create
                if(e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') {
                    try {
                        await createUserWithEmailAndPassword(window.auth, email, pass);
                        document.getElementById('authBox').classList.add('hidden');
                        document.getElementById('creatorBox').classList.remove('hidden');
                        window.setTab('skin');
                        renderOptions('skin');
                        window.updateSignupPreview();
                    } catch (createErr) {
                        if (createErr.code === 'auth/email-already-in-use') {
                            errBox.textContent = "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„ÙƒÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.";
                        } else {
                            errBox.textContent = translateError(createErr.code);
                        }
                        errBox.classList.remove('hidden');
                    }
                } else {
                    errBox.textContent = translateError(e.code);
                    errBox.classList.remove('hidden');
                }
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function translateError(code) {
            if(code === 'auth/wrong-password') return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
            if(code === 'auth/invalid-credential') return "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
            if(code === 'auth/email-already-in-use') return "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";
            if(code === 'auth/weak-password') return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).";
            if(code === 'auth/invalid-email') return "ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
            if(code === 'auth/operation-not-allowed') return "âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Email/Password ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³.";
            if(code === 'auth/too-many-requests') return "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ ÙƒØ«Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.";
            return "Ø­Ø¯Ø« Ø®Ø·Ø£: " + code;
        }

        window.saveNewCharacter = async function() {
            const name = document.getElementById('signupName').value.trim();
            if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");

            const newComp = { 
                id: window.currentUser.uid, 
                name: name, 
                points: 0, 
                avatar: { ...window.avatarState },
                miracle: window.selectedMiracle
            };

            // Double check existence
            const exists = window.competitors.find(c => c.id === window.currentUser.uid);
            
            try {
                if(exists) {
                    const updatedTeams = window.competitors.map(c => c.id === window.currentUser.uid ? newComp : c);
                    await updateDoc(doc(window.db, "competitions", DOC_ID), { teams: updatedTeams });
                } else {
                    await updateDoc(doc(window.db, "competitions", DOC_ID), { teams: arrayUnion(newComp) });
                }
                document.getElementById('signupModal').classList.add('hidden');
            } catch (e) {
                alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message);
            }
        }

        function checkPassAnimation(prev, curr) {
            if (prev.length === 0) return;
            const prevSorted = [...prev].sort((a,b) => b.points - a.points);
            const currSorted = [...curr].sort((a,b) => b.points - a.points);

            currSorted.forEach((c, idx) => {
                const oldIdx = prevSorted.findIndex(p => p.id === c.id);
                if (oldIdx !== -1 && idx < oldIdx) {
                    setTimeout(() => {
                        const row = document.getElementById(`row-${c.id}`);
                        if (row) {
                            row.classList.add('pass-anim');
                            setTimeout(() => row.classList.remove('pass-anim'), 800);
                        }
                    }, 100);
                }
            });
        }

        window.saveDataToCloud = async function() {
            if (!window.db) return;
            await updateDoc(doc(window.db, "competitions", DOC_ID), { teams: window.competitors });
        }

        window.saveVerseFromAdmin = async function() {
            if (!window.isAdmin) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©");
            const txt = document.getElementById('adminVerseInput').value;
            if (!window.db) return;
            await updateDoc(doc(window.db, "competitions", DOC_ID), { verse: txt });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­");
        }

        window.saveVerse = async function() { window.saveVerseFromAdmin(); }

        window.setTab = function(tabName) {
            document.querySelectorAll('.creator-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            renderOptions(tabName);
        }

        function renderOptions(type) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            container.className = (type === 'miracle') ? "grid grid-cols-2 gap-3 p-2" : "option-grid";

            if (type === 'skin') {
                ASSETS.skinColors.forEach(c => {
                    container.innerHTML += `<div class="color-dot ${window.avatarState.skinColor === c ? 'selected' : ''}" style="background:${c}" onclick="setAvatarProp('skinColor', '${c}')"></div>`;
                });
            } else if (type === 'hair') {
                const colorDiv = document.createElement('div'); colorDiv.className = "option-grid mb-4 col-span-full";
                ASSETS.hairColors.forEach(c => {
                    colorDiv.innerHTML += `<div class="color-dot ${window.avatarState.hairColor === c ? 'selected' : ''}" style="background:${c}" onclick="setAvatarProp('hairColor', '${c}')"></div>`;
                });
                container.appendChild(colorDiv);
                
                PATHS.hair.forEach((_, i) => {
                    const tempState = {...window.avatarState, hairStyle: i};
                    container.innerHTML += `<div class="item-btn ${window.avatarState.hairStyle === i ? 'selected' : ''}" onclick="setAvatarProp('hairStyle', ${i})"><div class="w-10 h-10 overflow-hidden relative">${window.getAvatarSVG(tempState)}</div></div>`;
                });
            } else if (type === 'clothes') {
                const colorDiv = document.createElement('div'); colorDiv.className = "option-grid mb-4 col-span-full";
                ASSETS.clothesColors.forEach(c => {
                    colorDiv.innerHTML += `<div class="color-dot ${window.avatarState.clothesColor === c ? 'selected' : ''}" style="background:${c}" onclick="setAvatarProp('clothesColor', '${c}')"></div>`;
                });
                container.appendChild(colorDiv);
                
                PATHS.clothes.forEach((_, i) => {
                    const tempState = {...window.avatarState, clothesStyle: i};
                    container.innerHTML += `<div class="item-btn ${window.avatarState.clothesStyle === i ? 'selected' : ''}" onclick="setAvatarProp('clothesStyle', ${i})"><div class="w-10 h-10 overflow-hidden relative">${window.getAvatarSVG(tempState)}</div></div>`;
                });
            } else if (type === 'eyes') {
                PATHS.eyes.forEach((_, i) => {
                    const tempState = {...window.avatarState, eyeStyle: i};
                    container.innerHTML += `<div class="item-btn ${window.avatarState.eyeStyle === i ? 'selected' : ''}" onclick="setAvatarProp('eyeStyle', ${i})"><div class="w-10 h-10 overflow-hidden relative scale-150 origin-center">${window.getAvatarSVG(tempState)}</div></div>`;
                });
            } else if (type === 'mouth') {
                PATHS.mouths.forEach((_, i) => {
                    const tempState = {...window.avatarState, mouthStyle: i};
                    container.innerHTML += `<div class="item-btn ${window.avatarState.mouthStyle === i ? 'selected' : ''}" onclick="setAvatarProp('mouthStyle', ${i})"><div class="w-10 h-10 overflow-hidden relative scale-150 origin-center">${window.getAvatarSVG(tempState)}</div></div>`;
                });
            } else if (type === 'miracle') {
                ASSETS.miracles.forEach(m => {
                    const isSelected = window.selectedMiracle === m.id;
                    container.innerHTML += `
                        <div onclick="selectMiracle('${m.id}', '${m.name}')" class="cursor-pointer p-4 rounded-xl border flex flex-col items-center justify-center gap-2 transition ${isSelected ? 'bg-amber-900/60 border-amber-400' : 'bg-slate-800 border-slate-700'}">
                            <span class="text-4xl">${m.icon}</span>
                            <span class="text-xs font-bold text-gray-300">${m.name}</span>
                        </div>`;
                });
            }
        }

        window.setAvatarProp = function(key, val) {
            window.avatarState[key] = val;
            const currentTab = document.querySelector('.creator-tab.active').id.replace('tab-','');
            renderOptions(currentTab); 
            window.updateSignupPreview();
        }

        window.selectMiracle = function(id, name) {
            window.selectedMiracle = id;
            document.getElementById('signupMiracleName').textContent = name;
            const m = ASSETS.miracles.find(x => x.id === id);
            document.getElementById('signupMiracleIcon').textContent = m ? m.icon : 'âœ¨';
            renderOptions('miracle');
        }

        window.deleteCompetitor = function(id) { if(confirm('Ø­Ø°ÙØŸ')) { window.competitors = window.competitors.filter(c => c.id !== id); saveDataToCloud(); } }
        window.changePoints = function(id, d) { const c = window.competitors.find(x => x.id === id); if(c) { c.points += d; saveDataToCloud(); } }
        window.deleteAllData = function() { if(confirm('ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ')) { window.competitors = []; saveDataToCloud(); } }
    </script>

    <script>
        function triggerMiracle(type) {
            const overlay = document.getElementById('miracleOverlay');
            overlay.classList.remove('hidden');
            overlay.innerHTML = ''; 
            document.body.style.overflow = 'hidden';

            let content = '';
            if(type === 'bush') content = `<div class="text-[120px] transition-all duration-1000 animate-bounce">ğŸ”¥ğŸŒ³</div>`;
            else if(type === 'snake') content = `<div class="flex flex-col items-center"><div class="text-[100px] animate-[spin_0.5s_ease-out]">ğŸªµ</div><div class="text-[150px] absolute transition-all duration-1000 transform scale-150 text-green-500 animate-pulse delay-500">ğŸ</div></div>`;
            else if(type === 'blood') content = `<div class="absolute inset-0 bg-blue-500/50 z-10 transition-colors duration-1000 bg-red-700/80 flex items-center justify-center"><div class="text-9xl animate-bounce">ğŸ’§ â¡ï¸ ğŸ©¸</div></div>`;
            else if(type === 'sea') content = `<div class="flex w-full h-full"><div class="w-1/2 bg-blue-600/80 translate-x-[-100%] transition duration-1000 transform translate-x-0 border-r-4 border-white"></div><div class="w-1/2 bg-blue-600/80 translate-x-[100%] transition duration-1000 transform translate-x-0 border-l-4 border-white"></div></div>`;
            else if(type === 'frog') content = `<div class="grid grid-cols-3 gap-10"><div class="text-8xl animate-bounce">ğŸ¸</div><div class="text-8xl animate-bounce delay-100">ğŸ¸</div><div class="text-8xl animate-bounce delay-200">ğŸ¸</div></div>`;
            else content = `<div class="text-9xl animate-pulse">âœ¨</div>`;

            overlay.innerHTML = `<div class="flex items-center justify-center h-full w-full bg-black/60 backdrop-blur-sm">${content}</div>`;

            setTimeout(() => {
                overlay.classList.add('hidden');
                document.body.style.overflow = ''; 
            }, 3000);
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            const sorted = [...window.competitors].sort((a,b) => b.points - a.points);

            if (sorted.length === 0) { list.innerHTML = '<div class="text-center text-white/50 py-10">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø¨Ø·Ø§Ù„...</div>'; return; }

            sorted.forEach((c, index) => {
                const rank = index + 1;
                let rankClass = '', rankIcon = `<span class="text-xl font-bold number-en text-slate-500">#${rank}</span>`, glowClass = '';
                if (rank === 1) { rankClass = 'rank-1'; rankIcon = '<i class="fas fa-fire text-red-500 text-2xl animate-pulse"></i>'; glowClass = 'weekly-winner-glow'; }
                else if (rank === 2) { rankClass = 'rank-2'; rankIcon = '<i class="fas fa-star text-yellow-400 text-xl"></i>'; }
                else if (rank === 3) { rankClass = 'rank-3'; }

                const avatarSvg = window.getAvatarSVG ? window.getAvatarSVG(c.avatar) : '';
                
                // Show Base Icon until clicked
                const miracleMap = { 'bush':'ğŸŒ³', 'snake':'ğŸªµ', 'blood':'ğŸ’§', 'sea':'ğŸŒŠ', 'frog':'â›²', 'light':'â˜ï¸', 'manna':'ğŸ§º' };
                const baseIcon = miracleMap[c.miracle] || 'âœ¨';
                
                const isMe = window.currentUser && c.id === window.currentUser.uid;
                const highlight = isMe ? 'border border-amber-400 bg-amber-900/20' : '';

                const html = `
                    <div id="row-${c.id}" class="competitor-card flex items-center p-2 rounded-xl bg-black/30 ${rankClass} ${glowClass} ${highlight} mb-3 shadow-lg transform transition hover:scale-[1.01]">
                        <div class="w-10 flex justify-center items-center">${rankIcon}</div>
                        <div class="w-20 h-20 -mt-2 big-head-wrapper drop-shadow-2xl">${avatarSvg}</div>
                        <div class="flex-1 pr-4 text-right">
                            <h3 class="text-lg md:text-xl font-bold text-white truncate drop-shadow-md">
                                ${c.name}
                                ${isMe ? '<span class="text-[10px] bg-amber-500 text-black px-1 rounded mr-2">Ø£Ù†Ø§</span>' : ''}
                            </h3>
                        </div>
                        <div class="w-20 flex justify-center pl-2">
                            <button onclick="triggerMiracle('${c.miracle}')" class="miracle-btn text-3xl hover:scale-125 transition">
                                ${baseIcon}
                            </button>
                        </div>
                        <div class="w-16 text-center">
                            <span class="text-2xl font-black text-amber-400 number-en drop-shadow-md">${c.points}</span>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderAdminList() {
            const list = document.getElementById('adminList');
            list.innerHTML = '';
            window.competitors.sort((a,b) => b.points - a.points).forEach((c) => {
                list.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-slate-700 mb-2">
                        <div class="flex items-center gap-2 overflow-hidden flex-1">
                            <div class="w-8 h-8">${window.getAvatarSVG(c.avatar)}</div>
                            <span class="truncate text-xs font-bold text-gray-300">${c.name}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="changePoints('${c.id}', -5)" class="w-6 h-6 bg-slate-700 rounded hover:bg-red-900 text-red-200 text-xs font-bold">-5</button>
                            <span class="w-10 text-center text-amber-400 font-mono text-sm">${c.points}</span>
                            <button onclick="changePoints('${c.id}', 5)" class="w-6 h-6 bg-slate-700 rounded hover:bg-green-900 text-green-200 text-xs font-bold">+5</button>
                            <button onclick="deleteCompetitor('${c.id}')" class="w-6 h-6 ml-1 text-slate-500 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `);
            });
        }

        window.openAdminLogin = () => { document.getElementById('adminPass').value = ''; document.getElementById('loginModal').classList.remove('hidden'); }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.checkLogin = () => { 
            if (document.getElementById('adminPass').value === '1123') { 
                window.isAdmin = true; 
                window.closeModal('loginModal'); 
                document.getElementById('adminModal').classList.remove('hidden'); 
                renderAdminList(); 
                if (document.getElementById('adminVerseInput')) document.getElementById('adminVerseInput').value = window.currentVerse;
            } else { alert("Ø®Ø·Ø£"); } 
        }
        window.openVerseModal = () => { document.getElementById('verseModal').classList.remove('hidden'); }
        window.toggleMusic = () => { 
            const a = document.getElementById('bgMusic'), i = document.getElementById('musicIcon'); 
            if(a.paused) { a.play(); i.className = 'fas fa-volume-up text-amber-400'; } else { a.pause(); i.className = 'fas fa-volume-mute text-white/50'; } 
        }
        window.triggerMiracle = triggerMiracle;
    </script>
</body>
</html>
