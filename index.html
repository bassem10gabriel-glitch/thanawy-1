<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقة الخروج - Exodus Competition</title>
    
    <!-- Fonts: Amiri for Biblical feel, Tajawal for UI -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome for generic icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --sea-dark: #0f172a;
            --sea-light: #1e3a8a;
            --sand: #f5f5f4;
            --gold: #fbbf24;
            --fire: #ef4444;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--sea-dark);
            color: white;
            overflow-x: hidden;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .biblical-font {
            font-family: 'Amiri', serif;
        }

        /* --- Red Sea Animation Background --- */
        .red-sea-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(circle at center bottom, #2c1a0d 0%, #0f172a 60%);
        }

        .wave-wall {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40%;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), rgba(30, 58, 138, 0.6));
            filter: url(#water);
            opacity: 0.8;
            transition: all 2s ease;
        }

        .wave-left { left: 0; transform-origin: left; animation: swell 6s infinite ease-in-out; }
        .wave-right { right: 0; transform-origin: right; animation: swell 6s infinite ease-in-out reverse; }

        @keyframes swell {
            0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(1.05); }
        }

        /* --- Leaderboard Items --- */
        .competitor-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Top 3 Styles */
        .rank-1 {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2), transparent);
            border-right: 4px solid var(--fire);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }
        .rank-2 {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
            border-right: 4px solid var(--gold);
        }
        .rank-3 {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.15), transparent);
            border-right: 4px solid #94a3b8;
        }

        .weekly-winner-glow {
            animation: holyGlow 3s infinite alternate;
        }

        @keyframes holyGlow {
            from { box-shadow: 0 0 10px var(--gold); }
            to { box-shadow: 0 0 30px var(--gold), 0 0 10px white; }
        }

        /* Helpers */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Arabic Number Support overrides */
        .number-en { font-family: sans-serif; direction: ltr; display: inline-block; }
    </style>
</head>
<body>

    <!-- SVG Filters for Water Effect -->
    <svg style="position: absolute; width: 0; height: 0;">
        <filter id="water">
            <feTurbulence type="fractalNoise" baseFrequency="0.01 0.05" numOctaves="3" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" />
        </filter>
    </svg>

    <!-- Background -->
    <div class="red-sea-bg">
        <div class="wave-wall wave-left"></div>
        <div class="wave-wall wave-right"></div>
        <!-- Light reflection in center -->
        <div class="absolute inset-0 flex justify-center items-end opacity-20 pointer-events-none">
            <div class="w-1/3 h-full bg-gradient-to-t from-yellow-100 to-transparent"></div>
        </div>
    </div>

    <!-- Audio Player (Hidden UI, toggled by button) -->
    <audio id="bgMusic" loop>
        <!-- Using a free placeholder sound of ocean/calm drone. 
             HOST: Replace 'src' with your own MP3 file link if desired -->
        <source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_884fe92c21.mp3?filename=soft-ambient-116346.mp3" type="audio/mpeg">
    </audio>

    <!-- Main Content -->
    <div class="relative z-10 flex flex-col h-full max-w-4xl mx-auto w-full p-4">
        
        <!-- Header -->
        <header class="text-center py-6 relative">
            <h1 class="text-4xl md:text-6xl text-amber-400 biblical-font font-bold drop-shadow-lg mb-2">مسابقة رحلة الخروج</h1>
            <p class="text-blue-200 text-lg opacity-80">"الرَّبُّ يُقَاتِلُ عَنْكُمْ وَأَنْتُمْ تَصْمُتُونَ" (خروج 14: 14)</p>
            
            <!-- Music Control -->
            <button id="musicToggle" onclick="toggleMusic()" class="absolute top-4 left-4 text-white/50 hover:text-amber-400 transition">
                <i class="fas fa-volume-mute text-2xl" id="musicIcon"></i>
            </button>
        </header>

        <!-- Leaderboard Container -->
        <main class="flex-1 overflow-hidden flex flex-col glass-panel rounded-2xl shadow-2xl">
            <!-- Table Header -->
            <div class="flex justify-between items-center p-4 bg-black/40 text-amber-100/70 text-sm font-bold uppercase tracking-wider">
                <div class="w-16 text-center">الترتيب</div>
                <div class="flex-1 pr-4">المتسابق</div>
                <div class="w-24 text-center">النقاط</div>
            </div>

            <!-- List -->
            <div id="leaderboardList" class="flex-1 overflow-y-auto custom-scroll relative">
                <!-- Competitors injected here by JS -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="py-4 text-center text-xs text-white/30">
            <button onclick="openAdminLogin()" class="hover:text-white transition">Admin Login</button>
            <span> | Exodus Theme v1.0</span>
        </footer>
    </div>

    <!-- MODAL: Admin Login -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hidden">
        <div class="bg-slate-800 p-8 rounded-xl border border-amber-500/30 w-full max-w-sm text-center">
            <h2 class="text-2xl text-amber-400 biblical-font mb-6">الدخول إلى لوحة التحكم</h2>
            <input type="password" id="adminPass" placeholder="كلمة المرور" class="w-full p-3 bg-slate-900 border border-slate-700 rounded mb-4 text-center text-white focus:outline-none focus:border-amber-500">
            <div class="flex gap-2">
                <button onclick="closeModal('loginModal')" class="flex-1 py-2 bg-slate-700 rounded hover:bg-slate-600">إلغاء</button>
                <button onclick="checkLogin()" class="flex-1 py-2 bg-amber-600 text-black font-bold rounded hover:bg-amber-500">دخول</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Dashboard -->
    <div id="adminModal" class="fixed inset-0 bg-black/95 z-50 flex flex-col hidden overflow-y-auto">
        <div class="p-4 md:p-8 max-w-5xl mx-auto w-full">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-3xl text-amber-400 biblical-font">لوحة تحكم القائد (Host)</h2>
                <button onclick="logout()" class="px-4 py-2 bg-red-900/50 hover:bg-red-600 rounded text-red-200 hover:text-white transition">
                    <i class="fas fa-sign-out-alt ml-2"></i>خروج
                </button>
            </div>

            <!-- Add New Competitor -->
            <div class="bg-slate-800/50 p-6 rounded-xl border border-white/5 mb-8">
                <h3 class="text-xl mb-4 text-blue-200">إضافة متسابق جديد</h3>
                <div class="flex flex-col md:flex-row gap-4 items-start">
                    <!-- Image Upload -->
                    <div class="w-full md:w-auto flex flex-col items-center">
                        <label for="newImgInput" class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center cursor-pointer hover:bg-slate-600 overflow-hidden border-2 border-dashed border-slate-500">
                            <img id="previewImg" src="" class="w-full h-full object-cover hidden">
                            <i id="uploadIcon" class="fas fa-camera text-white/50"></i>
                        </label>
                        <input type="file" id="newImgInput" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                        <span class="text-xs mt-2 text-slate-400">صورة</span>
                    </div>

                    <input type="text" id="newName" placeholder="اسم المتسابق/الفريق" class="flex-1 bg-slate-900 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-amber-500 w-full">
                    <input type="number" id="newPoints" placeholder="0" class="w-full md:w-24 bg-slate-900 border border-slate-700 p-3 rounded text-white text-center focus:outline-none focus:border-amber-500 number-en">
                    
                    <button onclick="addCompetitor()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded font-bold w-full md:w-auto">
                        <i class="fas fa-plus ml-2"></i>إضافة
                    </button>
                </div>
            </div>

            <!-- Manage List -->
            <div class="bg-slate-800/50 p-6 rounded-xl border border-white/5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl text-blue-200">تعديل النقاط</h3>
                    <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-300 underline">حذف جميع البيانات</button>
                </div>
                
                <div id="adminList" class="space-y-2">
                    <!-- Admin Items injected here -->
                </div>
            </div>

            <button onclick="closeModal('adminModal')" class="mt-8 mx-auto text-slate-400 hover:text-white">العودة للمشاهدة فقط</button>
        </div>
    </div>

    <script>
        /* ------------------------------------------------------------
           CONFIGURATION & STATE
        ------------------------------------------------------------ */
        const STORAGE_KEY = 'exodus_competition_data';
        const CHANNEL_NAME = 'exodus_sync_channel';
        const PASS_HASH = '1123'; // Simple check for the requested password

        // Initial Sample Data (Can be deleted by admin)
        const SAMPLE_DATA = [
            { id: 1, name: "فريق موسى", points: 150, image: null },
            { id: 2, name: "فريق هارون", points: 120, image: null },
            { id: 3, name: "فريق مريم", points: 95, image: null },
            { id: 4, name: "يشوع بن نون", points: 80, image: null },
            { id: 5, name: "كالب بن يفنة", points: 60, image: null }
        ];

        let competitors = [];
        let broadcastChannel;

        /* ------------------------------------------------------------
           ICONS (Inline SVG for Biblical Theme)
        ------------------------------------------------------------ */
        const icons = {
            fire: `<svg class="w-8 h-8 text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c4.97 0 9-4.03 9-9 0-4.97-9-13-9-13S3 8.03 3 13c0 4.97 4.03 9 9 9zm0-2c-3.87 0-7-3.13-7-7 0-2.26 3.14-6.42 5.71-9.69C11.54 4.3 12 3.71 12 3.71s.46.59 1.29 1.6C15.86 8.58 19 12.74 19 13c0 3.87-3.13 7-7 7z"/></svg>`,
            tablets: `<svg class="w-8 h-8 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M6 2h12a2 2 0 012 2v18H4V4a2 2 0 012-2zm2 4v2h2V6H8zm4 0v2h2V6h-2zm-4 4v2h2v-2H8zm4 0v2h2v-2h-2zm-4 4v2h2v-2H8zm4 0v2h2v-2h-2z"/></svg>`,
            staff: `<svg class="w-8 h-8 text-amber-600 transform rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M5 22h2l1.5-5 .5-1.5L7 3h2l2 12.5.5 1.5L13 22h2l-2.5-7-2-13H8L6 15z"/></svg>`
        };

        /* ------------------------------------------------------------
           INITIALIZATION
        ------------------------------------------------------------ */
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initBroadcastChannel();
            renderLeaderboard();
        });

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                competitors = JSON.parse(stored);
            } else {
                competitors = [...SAMPLE_DATA];
                saveData(false); // Save initial sample data
            }
        }

        function saveData(broadcast = true) {
            // Sort by points DESC
            competitors.sort((a, b) => b.points - a.points);
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(competitors));
            
            if (broadcast) {
                broadcastChannel.postMessage({ type: 'UPDATE', data: competitors });
            }
            
            renderLeaderboard();
            renderAdminList(); // Update admin view if open
        }

        /* ------------------------------------------------------------
           SYNC LOGIC (BroadcastChannel)
        ------------------------------------------------------------ */
        function initBroadcastChannel() {
            broadcastChannel = new BroadcastChannel(CHANNEL_NAME);
            broadcastChannel.onmessage = (event) => {
                if (event.data.type === 'UPDATE') {
                    competitors = event.data.data;
                    renderLeaderboard();
                    // If admin is open on this secondary screen (unlikely but possible), update it
                    if(!document.getElementById('adminModal').classList.contains('hidden')){
                         renderAdminList();
                    }
                }
            };
        }

        /* ------------------------------------------------------------
           RENDERING
        ------------------------------------------------------------ */
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';

            competitors.forEach((c, index) => {
                const rank = index + 1;
                let rankClass = '';
                let rankIcon = `<span class="text-xl font-bold number-en text-slate-500">#${rank}</span>`;
                let glowClass = '';

                // Special styling for Top 3
                if (rank === 1) {
                    rankClass = 'rank-1';
                    rankIcon = icons.fire;
                    glowClass = 'weekly-winner-glow';
                } else if (rank === 2) {
                    rankClass = 'rank-2';
                    rankIcon = icons.tablets;
                } else if (rank === 3) {
                    rankClass = 'rank-3';
                    rankIcon = icons.staff;
                }

                // Image Handling (Default placeholder or User Image)
                const imgDisplay = c.image 
                    ? `<img src="${c.image}" class="w-full h-full object-cover">`
                    : `<div class="w-full h-full bg-slate-700 flex items-center justify-center text-slate-500 font-bold text-lg">${c.name.charAt(0)}</div>`;

                const html = `
                    <div class="competitor-card flex items-center p-4 ${rankClass} ${glowClass}">
                        <!-- Rank/Icon -->
                        <div class="w-16 flex justify-center items-center">
                            ${rankIcon}
                        </div>
                        
                        <!-- Avatar -->
                        <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-white/20 ml-4 shadow-lg shrink-0">
                            ${imgDisplay}
                        </div>

                        <!-- Name -->
                        <div class="flex-1">
                            <h3 class="text-lg md:text-xl font-bold text-white truncate">${c.name}</h3>
                            ${rank === 1 ? '<span class="text-xs text-amber-400 font-bold animate-pulse">متصدر الأسبوع</span>' : ''}
                        </div>

                        <!-- Points -->
                        <div class="w-24 text-center">
                            <span class="text-2xl font-bold text-amber-400 number-en" id="score-${c.id}">${c.points}</span>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderAdminList() {
            const list = document.getElementById('adminList');
            list.innerHTML = '';

            competitors.forEach((c) => {
                const html = `
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded border border-slate-700">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="w-8 h-8 rounded-full bg-slate-700 overflow-hidden shrink-0">
                                ${c.image ? `<img src="${c.image}" class="w-full h-full object-cover">` : ''}
                            </div>
                            <span class="truncate">${c.name}</span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button onclick="changePoints(${c.id}, -5)" class="w-8 h-8 bg-slate-700 rounded hover:bg-red-900 text-red-200 number-en">-5</button>
                            <input onchange="manualEditPoints(${c.id}, this.value)" type="number" value="${c.points}" class="w-16 bg-black border border-slate-600 rounded p-1 text-center text-amber-400 number-en">
                            <button onclick="changePoints(${c.id}, 5)" class="w-8 h-8 bg-slate-700 rounded hover:bg-green-900 text-green-200 number-en">+5</button>
                            <button onclick="deleteCompetitor(${c.id})" class="w-8 h-8 ml-2 text-slate-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        /* ------------------------------------------------------------
           ADMIN LOGIC
        ------------------------------------------------------------ */
        function openAdminLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function checkLogin() {
            const input = document.getElementById('adminPass').value;
            if (input === PASS_HASH) {
                closeModal('loginModal');
                document.getElementById('adminPass').value = '';
                document.getElementById('adminModal').classList.remove('hidden');
                renderAdminList();
            } else {
                alert("كلمة المرور غير صحيحة");
            }
        }

        function logout() {
            closeModal('adminModal');
        }

        // Add Competitor
        let tempImageBase64 = null;

        function handleImagePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = tempImageBase64;
                    document.getElementById('previewImg').classList.remove('hidden');
                    document.getElementById('uploadIcon').classList.add('hidden');
                }
                // Check size (simple check)
                if(input.files[0].size > 500000) { // 500KB limit warning
                    alert("تحذير: الصورة كبيرة جداً. يفضل استخدام صور صغيرة لضمان سرعة الموقع.");
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addCompetitor() {
            const nameInput = document.getElementById('newName');
            const pointsInput = document.getElementById('newPoints');
            
            const name = nameInput.value.trim();
            const points = parseInt(pointsInput.value) || 0;

            if (!name) return alert("الرجاء كتابة الاسم");

            const newComp = {
                id: Date.now(),
                name: name,
                points: points,
                image: tempImageBase64
            };

            competitors.push(newComp);
            saveData();
            
            // Reset Form
            nameInput.value = '';
            pointsInput.value = '';
            tempImageBase64 = null;
            document.getElementById('previewImg').src = '';
            document.getElementById('previewImg').classList.add('hidden');
            document.getElementById('uploadIcon').classList.remove('hidden');
            document.getElementById('newImgInput').value = '';
        }

        // Edit Points
        function changePoints(id, delta) {
            const comp = competitors.find(c => c.id === id);
            if (comp) {
                comp.points += delta;
                saveData();
            }
        }

        function manualEditPoints(id, value) {
            const comp = competitors.find(c => c.id === id);
            if (comp) {
                comp.points = parseInt(value) || 0;
                saveData();
            }
        }

        // Delete
        function deleteCompetitor(id) {
            if(confirm('هل أنت متأكد من حذف هذا المتسابق؟')) {
                competitors = competitors.filter(c => c.id !== id);
                saveData();
            }
        }

        // Reset All
        function resetData() {
            if(confirm('تحذير: سيتم مسح جميع البيانات والمتسابقين. هل أنت متأكد؟')) {
                competitors = [];
                localStorage.removeItem(STORAGE_KEY);
                saveData();
            }
        }

        /* ------------------------------------------------------------
           AUDIO LOGIC
        ------------------------------------------------------------ */
        function toggleMusic() {
            const audio = document.getElementById('bgMusic');
            const icon = document.getElementById('musicIcon');
            
            if (audio.paused) {
                audio.play();
                icon.classList.remove('fa-volume-mute');
                icon.classList.add('fa-volume-up');
                icon.parentElement.classList.remove('text-white/50');
                icon.parentElement.classList.add('text-amber-400');
            } else {
                audio.pause();
                icon.classList.remove('fa-volume-up');
                icon.classList.add('fa-volume-mute');
                icon.parentElement.classList.add('text-white/50');
                icon.parentElement.classList.remove('text-amber-400');
            }
        }
    </script>
</body>
</html>
